generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String     @id @default(uuid()) @db.Uuid
  email     String     @unique @db.VarChar(255)
  name      String?    @db.VarChar(255)
  avatarUrl String?    @map("avatar_url") @db.Text
  createdAt DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  projects  Project[]
  apiTokens ApiToken[]

  @@map("users")
}

model ApiToken {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  name       String    @db.VarChar(255)
  tokenHash  String    @map("token_hash") @db.VarChar(255)
  lastUsedAt DateTime? @map("last_used_at") @db.Timestamptz
  expiresAt  DateTime? @map("expires_at") @db.Timestamptz
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("api_tokens")
}

model Project {
  id                 String      @id @default(uuid()) @db.Uuid
  userId             String      @map("user_id") @db.Uuid
  slug               String      @db.VarChar(255)
  name               String      @db.VarChar(255)
  description        String?     @db.Text
  public             Boolean     @default(false)
  // GitHub integration
  githubRepo         String?     @map("github_repo") @db.VarChar(255) // e.g., "owner/repo"
  githubToken        String?     @map("github_token") @db.Text // encrypted PAT for posting comments
  githubPrComments   Boolean     @default(false) @map("github_pr_comments")
  githubStatusChecks Boolean     @default(false) @map("github_status_checks")
  createdAt          DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  branches           Branch[]
  testbeds           Testbed[]
  measures           Measure[]
  benchmarks         Benchmark[]
  reports            Report[]
  thresholds         Threshold[]

  @@unique([userId, slug])
  @@index([userId])
  @@index([githubRepo])
  @@map("projects")
}

model Branch {
  id         String      @id @default(uuid()) @db.Uuid
  projectId  String      @map("project_id") @db.Uuid
  name       String      @db.VarChar(255)
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz
  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reports    Report[]
  thresholds Threshold[]

  @@unique([projectId, name])
  @@index([projectId])
  @@map("branches")
}

model Testbed {
  id         String      @id @default(uuid()) @db.Uuid
  projectId  String      @map("project_id") @db.Uuid
  name       String      @db.VarChar(255)
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz
  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reports    Report[]
  thresholds Threshold[]

  @@unique([projectId, name])
  @@index([projectId])
  @@map("testbeds")
}

model Measure {
  id         String      @id @default(uuid()) @db.Uuid
  projectId  String      @map("project_id") @db.Uuid
  name       String      @db.VarChar(255)
  units      String?     @db.VarChar(50)
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz
  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  metrics    Metric[]
  thresholds Threshold[]

  @@unique([projectId, name])
  @@index([projectId])
  @@map("measures")
}

model Benchmark {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  name      String   @db.VarChar(1024)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  metrics   Metric[]

  @@unique([projectId, name])
  @@index([projectId])
  @@map("benchmarks")
}

model Report {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  branchId  String   @map("branch_id") @db.Uuid
  testbedId String   @map("testbed_id") @db.Uuid
  gitHash   String?  @map("git_hash") @db.VarChar(40)
  prNumber  Int?     @map("pr_number") // GitHub PR number for comment posting
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  branch    Branch   @relation(fields: [branchId], references: [id])
  testbed   Testbed  @relation(fields: [testbedId], references: [id])
  metrics   Metric[]

  @@index([projectId])
  @@index([branchId])
  @@index([createdAt])
  @@index([prNumber])
  @@map("reports")
}

model Metric {
  id          String    @id @default(uuid()) @db.Uuid
  reportId    String    @map("report_id") @db.Uuid
  benchmarkId String    @map("benchmark_id") @db.Uuid
  measureId   String    @map("measure_id") @db.Uuid
  value       Float     @db.DoublePrecision
  lowerValue  Float?    @map("lower_value") @db.DoublePrecision
  upperValue  Float?    @map("upper_value") @db.DoublePrecision
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  report      Report    @relation(fields: [reportId], references: [id], onDelete: Cascade)
  benchmark   Benchmark @relation(fields: [benchmarkId], references: [id])
  measure     Measure   @relation(fields: [measureId], references: [id])
  alerts      Alert[]

  @@index([reportId])
  @@index([benchmarkId])
  @@index([createdAt])
  @@map("metrics")
}

model Threshold {
  id            String   @id @default(uuid()) @db.Uuid
  projectId     String   @map("project_id") @db.Uuid
  branchId      String?  @map("branch_id") @db.Uuid
  testbedId     String?  @map("testbed_id") @db.Uuid
  measureId     String   @map("measure_id") @db.Uuid
  upperBoundary Float?   @map("upper_boundary") @db.DoublePrecision
  lowerBoundary Float?   @map("lower_boundary") @db.DoublePrecision
  minSampleSize Int      @default(2) @map("min_sample_size")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  branch        Branch?  @relation(fields: [branchId], references: [id])
  testbed       Testbed? @relation(fields: [testbedId], references: [id])
  measure       Measure  @relation(fields: [measureId], references: [id])
  alerts        Alert[]

  @@index([projectId])
  @@map("thresholds")
}

model Alert {
  id            String    @id @default(uuid()) @db.Uuid
  thresholdId   String    @map("threshold_id") @db.Uuid
  metricId      String    @map("metric_id") @db.Uuid
  baselineValue Float     @map("baseline_value") @db.DoublePrecision
  percentChange Float     @map("percent_change") @db.DoublePrecision
  status        String    @default("active") @db.VarChar(20)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  threshold     Threshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
  metric        Metric    @relation(fields: [metricId], references: [id], onDelete: Cascade)

  @@index([thresholdId])
  @@index([status])
  @@map("alerts")
}
